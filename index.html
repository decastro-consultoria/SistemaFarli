<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Viagens - Farli</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // ⚠️ IMPORTANTE: Configure esta URL após criar o Google Apps Script
        // Instruções no arquivo INSTRUCOES_CONFIGURACAO.txt
        const SCRIPT_URL = 'https://script.google.com/macros/s/SEU_SCRIPT_ID_AQUI/exec';
        const USE_GOOGLE_SHEETS = false; // Mude para true após configurar
        
        const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const X = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Car = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 16H9m10 0h3v-3.15a1 1 0 0 0-.84-.99L16 11l-2.7-3.6a1 1 0 0 0-.8-.4H5.24a2 2 0 0 0-1.8 1.1l-.8 1.63A6 6 0 0 0 2 12.42V16h2"/><circle cx="6.5" cy="16.5" r="2.5"/><circle cx="16.5" cy="16.5" r="2.5"/></svg>;
        const User = ({size = 16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const DollarSign = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const MapPin = ({size = 16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>;
        const CheckCircle = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const XCircle = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>;
        const Save = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const LogOut = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>;
        const Cloud = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>;
        const RefreshCw = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>;
        const TrendingUp = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const TrendingDown = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>;
        const AlertTriangle = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const Edit = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const Calendar = ({size = 20}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;

        function TravelControl() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [currentUser, setCurrentUser] = useState('');
          const [loginForm, setLoginForm] = useState({ username: '', password: '', email: '' });
          const [showRegister, setShowRegister] = useState(false);
          const [showForgotPassword, setShowForgotPassword] = useState(false);
          
          const [activeTab, setActiveTab] = useState('viagens');
          const [showNewTrip, setShowNewTrip] = useState(false);
          const [carregando, setCarregando] = useState(false);
          const [carregandoDados, setCarregandoDados] = useState(false);
          
          const [despesas, setDespesas] = useState(['Alimentação', 'Pedágio', 'Hospedagem', 'Manutenção']);
          const [motoristas, setMotoristas] = useState(['João Silva', 'Maria Santos']);
          const [veiculos, setVeiculos] = useState(['Fiat Uno - ABC-1234', 'VW Gol - XYZ-5678']);
          const [clientes, setClientes] = useState(['Cliente A', 'Cliente B', 'Cliente C']);
          
          const [novaViagem, setNovaViagem] = useState({
            cliente: '', motorista: '', veiculo: '', precoLitro: '', litrosAbastecidos: '',
            distancia: '', bemSucedida: true, despesas: [], valorVenda: '', dataViagem: ''
          });
          
          const [viagens, setViagens] = useState([]);
          const [editandoViagem, setEditandoViagem] = useState(null);
          
          const [showAddCliente, setShowAddCliente] = useState(false);
          const [showAddMotorista, setShowAddMotorista] = useState(false);
          const [showAddVeiculo, setShowAddVeiculo] = useState(false);
          const [showAddCategoria, setShowAddCategoria] = useState(false);
          const [novoClienteTemp, setNovoClienteTemp] = useState('');
          const [novoMotoristaTemp, setNovoMotoristaTemp] = useState('');
          const [novoVeiculoTemp, setNovoVeiculoTemp] = useState('');
          const [novaCategoriaTemp, setNovaCategoriaTemp] = useState('');
          
          const [novoItem, setNovoItem] = useState('');
          const [novaDespesa, setNovaDespesa] = useState({ categoria: '', valor: '' });
          const [showAddDespesa, setShowAddDespesa] = useState(false);
          
          const [editandoItem, setEditandoItem] = useState(null);
          const [itemEditado, setItemEditado] = useState('');
          const [tipoEditando, setTipoEditando] = useState('');
          
          const [mensagem, setMensagem] = useState({ texto: '', tipo: '' });
          
          const [searchCliente, setSearchCliente] = useState('');
          const [searchMotorista, setSearchMotorista] = useState('');
          const [searchVeiculo, setSearchVeiculo] = useState('');
          const [searchCategoria, setSearchCategoria] = useState('');
          const [showClienteDropdown, setShowClienteDropdown] = useState(false);
          const [showMotoristaDropdown, setShowMotoristaDropdown] = useState(false);
          const [showVeiculoDropdown, setShowVeiculoDropdown] = useState(false);
          const [showCategoriaDropdown, setShowCategoriaDropdown] = useState(false);

          // Gerenciamento de dados local
          const salvarDadosLocal = () => {
            const dados = {
              viagens,
              clientes,
              motoristas,
              veiculos,
              despesas
            };
            localStorage.setItem('dadosFarli', JSON.stringify(dados));
          };

          const carregarDadosLocal = () => {
            const dados = localStorage.getItem('dadosFarli');
            if (dados) {
              const parsed = JSON.parse(dados);
              setViagens(parsed.viagens || []);
              setClientes(parsed.clientes || ['Cliente A', 'Cliente B', 'Cliente C']);
              setMotoristas(parsed.motoristas || ['João Silva', 'Maria Santos']);
              setVeiculos(parsed.veiculos || ['Fiat Uno - ABC-1234', 'VW Gol - XYZ-5678']);
              setDespesas(parsed.despesas || ['Alimentação', 'Pedágio', 'Hospedagem', 'Manutenção']);
            }
          };

          // Integração Google Sheets
          const chamarGoogleSheets = async (action, dados) => {
            if (!USE_GOOGLE_SHEETS) {
              console.log('Google Sheets desabilitado - salvando localmente');
              return { success: true, local: true };
            }

            try {
              setCarregando(true);
              const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...dados })
              });
              
              // No-cors não permite ler a resposta, assume sucesso
              return { success: true };
            } catch (error) {
              console.error('Erro ao conectar Google Sheets:', error);
              mostrarMensagem('Erro ao conectar com Google Sheets', 'error');
              return { success: false };
            } finally {
              setCarregando(false);
            }
          };

          const carregarDadosDoSheets = async () => {
            if (!USE_GOOGLE_SHEETS) {
              carregarDadosLocal();
              mostrarMensagem('Dados carregados localmente', 'info');
              return;
            }

            try {
              setCarregandoDados(true);
              const response = await fetch(`${SCRIPT_URL}?action=carregarDados`, {
                method: 'GET'
              });
              
              const data = await response.json();
              
              if (data.success && data.dados) {
                setViagens(data.dados.viagens || []);
                setClientes(data.dados.clientes.length > 0 ? data.dados.clientes : clientes);
                setMotoristas(data.dados.motoristas.length > 0 ? data.dados.motoristas : motoristas);
                setVeiculos(data.dados.veiculos.length > 0 ? data.dados.veiculos : veiculos);
                setDespesas(data.dados.despesas.length > 0 ? data.dados.despesas : despesas);
                mostrarMensagem('Dados carregados do Google Sheets!', 'success');
              }
            } catch (error) {
              console.error('Erro ao carregar do Sheets:', error);
              carregarDadosLocal();
              mostrarMensagem('Carregado localmente (offline)', 'warning');
            } finally {
              setCarregandoDados(false);
            }
          };

          // Inicialização
          useEffect(() => {
            const user = localStorage.getItem('currentUser');
            if (user) {
              setCurrentUser(user);
              setIsAuthenticated(true);
            }
          }, []);

          useEffect(() => {
            if (isAuthenticated) {
              carregarDadosDoSheets();
            }
          }, [isAuthenticated]);

          // Salvar automaticamente no localStorage
          useEffect(() => {
            if (isAuthenticated) {
              salvarDadosLocal();
            }
          }, [viagens, clientes, motoristas, veiculos, despesas]);

          // Autenticação
          const handleLogin = () => {
            const { username, password } = loginForm;
            
            if (!username || !password) {
              mostrarMensagem('Preencha usuário e senha!', 'error');
              return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[username] && users[username].password === password) {
              setCurrentUser(username);
              setIsAuthenticated(true);
              localStorage.setItem('currentUser', username);
              mostrarMensagem(`Bem-vindo, ${username}!`, 'success');
              setLoginForm({ username: '', password: '', email: '' });
            } else {
              mostrarMensagem('Usuário ou senha incorretos!', 'error');
            }
          };

          const handleRegister = () => {
            const { username, password, email } = loginForm;
            
            if (!username || !password || !email) {
              mostrarMensagem('Preencha todos os campos!', 'error');
              return;
            }

            if (username.length < 3) {
              mostrarMensagem('Usuário deve ter pelo menos 3 caracteres', 'error');
              return;
            }

            if (password.length < 4) {
              mostrarMensagem('Senha deve ter pelo menos 4 caracteres', 'error');
              return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              mostrarMensagem('Email inválido!', 'error');
              return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[username]) {
              mostrarMensagem('Usuário já existe!', 'warning');
              return;
            }

            users[username] = { password, email, createdAt: new Date().toISOString() };
            localStorage.setItem('users', JSON.stringify(users));
            mostrarMensagem('Cadastro realizado com sucesso!', 'success');
            setShowRegister(false);
            setLoginForm({ username, password: '', email: '' });
          };

          const handleForgotPassword = () => {
            const { username, email } = loginForm;
            
            if (!username || !email) {
              mostrarMensagem('Preencha usuário e email!', 'error');
              return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (!users[username]) {
              mostrarMensagem('Usuário não encontrado!', 'error');
              return;
            }

            if (users[username].email !== email) {
              mostrarMensagem('Email incorreto para este usuário!', 'error');
              return;
            }

            mostrarMensagem(`Sua senha é: ${users[username].password}`, 'info');
            setTimeout(() => {
              setShowForgotPassword(false);
              setLoginForm({ username: '', password: '', email: '' });
            }, 5000);
          };

          const handleLogout = () => {
            if (confirm('Deseja realmente sair?')) {
              setIsAuthenticated(false);
              setCurrentUser('');
              localStorage.removeItem('currentUser');
              mostrarMensagem('Até logo!', 'info');
            }
          };

          const mostrarMensagem = (texto, tipo = 'info') => {
            setMensagem({ texto, tipo });
            setTimeout(() => setMensagem({ texto: '', tipo: '' }), 4000);
          };

          // Filtros
          const clientesFiltrados = clientes.filter(c => c.toLowerCase().includes(searchCliente.toLowerCase()));
          const motoristasFiltrados = motoristas.filter(m => m.toLowerCase().includes(searchMotorista.toLowerCase()));
          const veiculosFiltrados = veiculos.filter(v => v.toLowerCase().includes(searchVeiculo.toLowerCase()));
          const despesasFiltradas = despesas.filter(d => d.toLowerCase().includes(searchCategoria.toLowerCase()));

          // Cadastros rápidos
          const adicionarClienteRapido = async () => {
            const novo = novoClienteTemp.trim();
            if (!novo) {
              mostrarMensagem('Digite um nome!', 'error');
              return;
            }
            
            if (clientes.some(c => c.toLowerCase() === novo.toLowerCase())) {
              mostrarMensagem('Cliente já existe!', 'warning');
              return;
            }
            
            setClientes([...clientes, novo]);
            setNovaViagem({...novaViagem, cliente: novo});
            setSearchCliente(novo);
            setNovoClienteTemp('');
            setShowAddCliente(false);
            
            await chamarGoogleSheets('salvarItem', { tipo: 'cliente', item: novo });
            mostrarMensagem('Cliente adicionado!', 'success');
          };

          const adicionarMotoristaRapido = async () => {
            const novo = novoMotoristaTemp.trim();
            if (!novo) {
              mostrarMensagem('Digite um nome!', 'error');
              return;
            }
            
            if (motoristas.some(m => m.toLowerCase() === novo.toLowerCase())) {
              mostrarMensagem('Motorista já existe!', 'warning');
              return;
            }
            
            setMotoristas([...motoristas, novo]);
            setNovaViagem({...novaViagem, motorista: novo});
            setSearchMotorista(novo);
            setNovoMotoristaTemp('');
            setShowAddMotorista(false);
            
            await chamarGoogleSheets('salvarItem', { tipo: 'motorista', item: novo });
            mostrarMensagem('Motorista adicionado!', 'success');
          };

          const adicionarVeiculoRapido = async () => {
            const novo = novoVeiculoTemp.trim();
            if (!novo) {
              mostrarMensagem('Digite os dados do veículo!', 'error');
              return;
            }
            
            if (veiculos.some(v => v.toLowerCase() === novo.toLowerCase())) {
              mostrarMensagem('Veículo já existe!', 'warning');
              return;
            }
            
            setVeiculos([...veiculos, novo]);
            setNovaViagem({...novaViagem, veiculo: novo});
            setSearchVeiculo(novo);
            setNovoVeiculoTemp('');
            setShowAddVeiculo(false);
            
            await chamarGoogleSheets('salvarItem', { tipo: 'veiculo', item: novo });
            mostrarMensagem('Veículo adicionado!', 'success');
          };

          const adicionarCategoriaRapida = async () => {
            const nova = novaCategoriaTemp.trim();
            if (!nova) {
              mostrarMensagem('Digite uma categoria!', 'error');
              return;
            }
            
            if (despesas.some(d => d.toLowerCase() === nova.toLowerCase())) {
              mostrarMensagem('Categoria já existe!', 'warning');
              return;
            }
            
            setDespesas([...despesas, nova]);
            setNovaDespesa({...novaDespesa, categoria: nova});
            setSearchCategoria(nova);
            setNovaCategoriaTemp('');
            setShowAddCategoria(false);
            
            await chamarGoogleSheets('salvarItem', { tipo: 'despesa', item: nova });
            mostrarMensagem('Categoria adicionada!', 'success');
          };

          // Despesas
          const adicionarDespesa = () => {
            if (!novaDespesa.categoria || !novaDespesa.valor) {
              mostrarMensagem('Preencha categoria e valor!', 'error');
              return;
            }

            if (parseFloat(novaDespesa.valor) <= 0) {
              mostrarMensagem('Valor deve ser maior que zero!', 'error');
              return;
            }
            
            setNovaViagem({
              ...novaViagem,
              despesas: [...novaViagem.despesas, { ...novaDespesa, id: Date.now() }]
            });
            setNovaDespesa({ categoria: '', valor: '' });
            setSearchCategoria('');
            setShowAddDespesa(false);
            mostrarMensagem('Despesa adicionada!', 'success');
          };

          const removerDespesa = (id) => {
            setNovaViagem({
              ...novaViagem,
              despesas: novaViagem.despesas.filter(d => d.id !== id)
            });
            mostrarMensagem('Despesa removida', 'info');
          };

          // Cálculos
          const calcularCombustivel = (viagem = novaViagem) => {
            if (viagem.litrosAbastecidos && viagem.precoLitro) {
              return (parseFloat(viagem.litrosAbastecidos) * parseFloat(viagem.precoLitro)).toFixed(2);
            }
            return '0.00';
          };

          const calcularConsumo = (viagem = novaViagem) => {
            if (viagem.distancia && viagem.litrosAbastecidos && parseFloat(viagem.litrosAbastecidos) > 0) {
              return (parseFloat(viagem.distancia) / parseFloat(viagem.litrosAbastecidos)).toFixed(2);
            }
            return '0.00';
          };

          const calcularTotalDespesas = (viagem) => {
            const total = viagem.despesas.reduce((acc, d) => acc + parseFloat(d.valor || 0), 0);
            return (total + parseFloat(calcularCombustivel(viagem))).toFixed(2);
          };

          const calcularLucro = (viagem) => {
            const valorVenda = parseFloat(viagem.valorVenda || 0);
            const totalDespesas = parseFloat(calcularTotalDespesas(viagem));
            return (valorVenda - totalDespesas).toFixed(2);
          };

          // Salvar ou editar viagem
          const salvarViagem = async () => {
            if (!novaViagem.cliente || !novaViagem.motorista || !novaViagem.veiculo) {
              mostrarMensagem('Preencha Cliente, Motorista e Veículo!', 'error');
              return;
            }

            if (editandoViagem) {
              // Modo edição
              const viagemAtualizada = {
                ...novaViagem,
                id: editandoViagem.id,
                dataRegistro: editandoViagem.dataRegistro,
                horaRegistro: editandoViagem.horaRegistro,
                usuario: currentUser,
                consumo: calcularConsumo(),
                totalCombustivel: calcularCombustivel(),
                totalGeral: calcularTotalDespesas(novaViagem),
                lucro: novaViagem.valorVenda ? calcularLucro(novaViagem) : '0.00'
              };

              setViagens(viagens.map(v => v.id === editandoViagem.id ? viagemAtualizada : v));
              await chamarGoogleSheets('editarViagem', { viagem: viagemAtualizada });
              mostrarMensagem('✅ Viagem atualizada com sucesso!', 'success');
              setEditandoViagem(null);
            } else {
              // Modo nova viagem
              const viagem = {
                ...novaViagem,
                id: Date.now(),
                dataRegistro: new Date().toLocaleDateString('pt-BR'),
                horaRegistro: new Date().toLocaleTimeString('pt-BR'),
                dataViagem: novaViagem.dataViagem || new Date().toLocaleDateString('pt-BR'),
                usuario: currentUser,
                consumo: calcularConsumo(),
                totalCombustivel: calcularCombustivel(),
                totalGeral: calcularTotalDespesas(novaViagem),
                lucro: novaViagem.valorVenda ? calcularLucro(novaViagem) : '0.00'
              };

              setViagens([viagem, ...viagens]);
              await chamarGoogleSheets('salvarViagem', { viagem });
              mostrarMensagem('✅ Viagem registrada com sucesso!', 'success');
            }
            
            setNovaViagem({
              cliente: '', motorista: '', veiculo: '', precoLitro: '', litrosAbastecidos: '',
              distancia: '', bemSucedida: true, despesas: [], valorVenda: '', dataViagem: ''
            });
            setSearchCliente('');
            setSearchMotorista('');
            setSearchVeiculo('');
            setShowNewTrip(false);
          };

          // Iniciar edição de viagem
          const iniciarEdicaoViagem = (viagem) => {
            setEditandoViagem(viagem);
            setNovaViagem({
              cliente: viagem.cliente,
              motorista: viagem.motorista,
              veiculo: viagem.veiculo,
              precoLitro: viagem.precoLitro,
              litrosAbastecidos: viagem.litrosAbastecidos,
              distancia: viagem.distancia,
              bemSucedida: viagem.bemSucedida,
              despesas: viagem.despesas || [],
              valorVenda: viagem.valorVenda || '',
              dataViagem: viagem.dataViagem || viagem.dataRegistro
            });
            setSearchCliente(viagem.cliente);
            setSearchMotorista(viagem.motorista);
            setSearchVeiculo(viagem.veiculo);
            setShowNewTrip(true);
          };

          // Excluir viagem
          const excluirViagem = async (id) => {
            if (!confirm('Tem certeza que deseja excluir esta viagem?')) return;
            
            setViagens(viagens.filter(v => v.id !== id));
            await chamarGoogleSheets('excluirViagem', { id });
            mostrarMensagem('Viagem excluída!', 'success');
          };

          // Gerenciar itens (cadastros)
          const adicionarNovoItem = async (tipo) => {
            const item = novoItem.trim();
            if (!item) {
              mostrarMensagem('Digite um valor!', 'error');
              return;
            }
            
            let arr, setArr;
            switch(tipo) {
              case 'despesa': arr = despesas; setArr = setDespesas; break;
              case 'motorista': arr = motoristas; setArr = setMotoristas; break;
              case 'veiculo': arr = veiculos; setArr = setVeiculos; break;
              case 'cliente': arr = clientes; setArr = setClientes; break;
            }
            
            if (arr.some(i => i.toLowerCase() === item.toLowerCase())) {
              mostrarMensagem('Item já existe!', 'warning');
              return;
            }
            
            setArr([...arr, item]);
            await chamarGoogleSheets('salvarItem', { tipo, item });
            mostrarMensagem('Item adicionado!', 'success');
            setNovoItem('');
          };

          const iniciarEdicao = (item, tipo) => {
            setEditandoItem(item);
            setItemEditado(item);
            setTipoEditando(tipo);
          };

          const salvarEdicao = async () => {
            const item = itemEditado.trim();
            if (!item || item === editandoItem) {
              setEditandoItem(null);
              return;
            }

            let arr, setArr;
            switch(tipoEditando) {
              case 'despesa': arr = despesas; setArr = setDespesas; break;
              case 'motorista': arr = motoristas; setArr = setMotoristas; break;
              case 'veiculo': arr = veiculos; setArr = setVeiculos; break;
              case 'cliente': arr = clientes; setArr = setClientes; break;
            }

            if (arr.some(i => i.toLowerCase() === item.toLowerCase() && i !== editandoItem)) {
              mostrarMensagem('Item já existe!', 'warning');
              return;
            }

            setArr(arr.map(i => i === editandoItem ? item : i));
            
            await chamarGoogleSheets('editarItem', { 
              tipo: tipoEditando, 
              itemAntigo: editandoItem, 
              itemNovo: item 
            });
            
            setEditandoItem(null);
            setItemEditado('');
            mostrarMensagem('Item editado!', 'success');
          };

          const cancelarEdicao = () => {
            setEditandoItem(null);
            setItemEditado('');
          };

          const removerItem = async (item, tipo) => {
            if (!confirm(`Tem certeza que deseja remover "${item}"?`)) return;

            switch(tipo) {
              case 'despesa': setDespesas(despesas.filter(d => d !== item)); break;
              case 'motorista': setMotoristas(motoristas.filter(m => m !== item)); break;
              case 'veiculo': setVeiculos(veiculos.filter(v => v !== item)); break;
              case 'cliente': setClientes(clientes.filter(c => c !== item)); break;
            }
            
            await chamarGoogleSheets('removerItem', { tipo, item });
            mostrarMensagem('Item removido!', 'success');
          };

          // TELA DE LOGIN
          if (!isAuthenticated) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-6">
                {mensagem.texto && (
                  <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg animate-fade-in ${
                    mensagem.tipo === 'success' ? 'bg-green-500 text-white' :
                    mensagem.tipo === 'error' ? 'bg-red-500 text-white' :
                    mensagem.tipo === 'warning' ? 'bg-orange-500 text-white' :
                    'bg-blue-500 text-white'
                  }`}>
                    <p className="font-semibold">{mensagem.texto}</p>
                  </div>
                )}
                
                <div className="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
                  <div className="text-center mb-8">
                    <div className="flex justify-center mb-4">
                      <Car size={64} />
                    </div>
                    <h1 className="text-3xl font-bold text-gray-800">Sistema Farli</h1>
                    <p className="text-gray-600 mt-2">Controle de Viagens</p>
                  </div>

                  {!USE_GOOGLE_SHEETS && (
                    <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm">
                      <p className="font-semibold flex items-center gap-2 text-yellow-800">
                        <AlertTriangle size={16} />
                        Modo Offline
                      </p>
                      <p className="text-yellow-700 text-xs mt-1">
                        Configure o Google Sheets para sincronização
                      </p>
                    </div>
                  )}

                  <div className="space-y-4">
                    <div>
                      <label className="block font-semibold mb-2 text-gray-700">Usuário</label>
                      <input
                        type="text"
                        value={loginForm.username}
                        onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                        placeholder="Digite seu usuário"
                        className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        onKeyPress={(e) => e.key === 'Enter' && !showRegister && !showForgotPassword && handleLogin()}
                      />
                    </div>
                    
                    {(showRegister || showForgotPassword) && (
                      <div>
                        <label className="block font-semibold mb-2 text-gray-700">Email</label>
                        <input
                          type="email"
                          value={loginForm.email}
                          onChange={(e) => setLoginForm({...loginForm, email: e.target.value})}
                          placeholder="Digite seu email"
                          className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                      </div>
                    )}
                    
                    {!showForgotPassword && (
                      <div>
                        <label className="block font-semibold mb-2 text-gray-700">Senha</label>
                        <input
                          type="password"
                          value={loginForm.password}
                          onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                          placeholder="Digite sua senha"
                          className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          onKeyPress={(e) => e.key === 'Enter' && (showRegister ? handleRegister() : handleLogin())}
                        />
                      </div>
                    )}

                    {!showRegister && !showForgotPassword && (
                      <>
                        <button
                          onClick={handleLogin}
                          className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-semibold"
                        >
                          Entrar
                        </button>
                        <div className="flex gap-2">
                          <button
                            onClick={() => setShowRegister(true)}
                            className="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg hover:bg-gray-300 transition font-semibold text-sm"
                          >
                            Criar Conta
                          </button>
                          <button
                            onClick={() => setShowForgotPassword(true)}
                            className="flex-1 bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition font-semibold text-sm"
                          >
                            Esqueci Senha
                          </button>
                        </div>
                      </>
                    )}
                    
                    {showRegister && (
                      <>
                        <button
                          onClick={handleRegister}
                          className="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold"
                        >
                          Cadastrar
                        </button>
                        <button
                          onClick={() => {setShowRegister(false); setLoginForm({ username: '', password: '', email: '' });}}
                          className="w-full bg-gray-200 text-gray-800 py-3 rounded-lg hover:bg-gray-300 transition font-semibold"
                        >
                          Voltar
                        </button>
                      </>
                    )}
                    
                    {showForgotPassword && (
                      <>
                        <button
                          onClick={handleForgotPassword}
                          className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-semibold"
                        >
                          Recuperar Senha
                        </button>
                        <button
                          onClick={() => {setShowForgotPassword(false); setLoginForm({ username: '', password: '', email: '' });}}
                          className="w-full bg-gray-200 text-gray-800 py-3 rounded-lg hover:bg-gray-300 transition font-semibold"
                        >
                          Voltar
                        </button>
                      </>
                    )}
                  </div>

                  <div className="mt-6 p-4 bg-blue-50 rounded-lg text-sm">
                    <p className="font-semibold flex items-center gap-2 mb-1">
                      <Cloud size={16} />
                      {USE_GOOGLE_SHEETS ? 'Google Sheets Ativo' : 'Armazenamento Local'}
                    </p>
                    <p className="text-gray-700 text-xs">
                      {USE_GOOGLE_SHEETS ? 'Dados salvos na planilha' : 'Dados salvos no navegador'}
                    </p>
                  </div>
                </div>
              </div>
            );
          }

          // TELA PRINCIPAL
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
              {mensagem.texto && (
                <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg animate-fade-in ${
                  mensagem.tipo === 'success' ? 'bg-green-500 text-white' :
                  mensagem.tipo === 'error' ? 'bg-red-500 text-white' :
                  mensagem.tipo === 'warning' ? 'bg-orange-500 text-white' :
                  'bg-blue-500 text-white'
                }`}>
                  <p className="font-semibold">{mensagem.texto}</p>
                </div>
              )}
              
              {(carregando || carregandoDados) && (
                <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2">
                  <div className="animate-spin"><RefreshCw size={20} /></div>
                  <span>{carregandoDados ? 'Carregando dados...' : 'Salvando...'}</span>
                </div>
              )}
              
              <div className="max-w-6xl mx-auto">
                {/* HEADER */}
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <div className="flex items-center justify-between flex-wrap gap-4">
                    <div>
                      <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                        <Car /> Sistema Farli
                      </h1>
                      <p className="text-gray-600 mt-1 flex items-center gap-2 flex-wrap">
                        <span>Olá, <strong>{currentUser}</strong>!</span>
                        <span className={`text-sm flex items-center gap-1 ${USE_GOOGLE_SHEETS ? 'text-green-600' : 'text-orange-600'}`}>
                          <Cloud size={14} /> {USE_GOOGLE_SHEETS ? 'Online' : 'Offline'}
                        </span>
                      </p>
                    </div>
                    <div className="flex gap-3 flex-wrap">
                      {USE_GOOGLE_SHEETS && (
                        <button
                          onClick={carregarDadosDoSheets}
                          className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2 font-semibold"
                          disabled={carregandoDados}
                        >
                          <RefreshCw size={16} /> Atualizar
                        </button>
                      )}
                      <button
                        onClick={() => setShowNewTrip(true)}
                        className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 font-semibold"
                      >
                        <Plus /> Nova Viagem
                      </button>
                      <button
                        onClick={handleLogout}
                        className="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 transition"
                        title="Sair"
                      >
                        <LogOut />
                      </button>
                    </div>
                  </div>
                </div>

                {/* TABS */}
                <div className="bg-white rounded-lg shadow-lg mb-6">
                  <div className="flex border-b">
                    {['viagens', 'cadastros'].map((tab) => (
                      <button
                        key={tab}
                        onClick={() => setActiveTab(tab)}
                        className={`flex-1 py-4 px-6 font-semibold capitalize transition ${
                          activeTab === tab ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-indigo-600'
                        }`}
                      >
                        {tab}
                      </button>
                    ))}
                  </div>

                  <div className="p-6">
                    {/* ABA VIAGENS */}
                    {activeTab === 'viagens' && (
                      <div>
                        <div className="flex justify-between items-center mb-4">
                          <h2 className="text-2xl font-bold">Viagens Registradas</h2>
                          <span className="text-gray-600 text-sm">Total: {viagens.length}</span>
                        </div>
                        {viagens.length === 0 ? (
                          <div className="text-center py-12 text-gray-500">
                            <div className="flex justify-center mb-4"><Car size={48} /></div>
                            <p className="text-lg font-semibold">Nenhuma viagem registrada</p>
                            <p className="text-sm mt-2">Clique em "Nova Viagem" para começar</p>
                          </div>
                        ) : (
                          <div className="space-y-4">
                            {viagens.map((v) => {
                              const lucro = calcularLucro(v);
                              const lucroPositivo = parseFloat(lucro) >= 0;
                              
                              return (
                                <div key={v.id} className="border rounded-lg p-4 hover:shadow-md transition bg-white">
                                  <div className="flex justify-between items-start flex-wrap gap-4">
                                    <div className="flex-1">
                                      <div className="flex items-center gap-2 mb-2 flex-wrap">
                                        <h3 className="font-bold text-lg">{v.cliente}</h3>
                                        {v.bemSucedida ? 
                                          <CheckCircle className="text-green-500" size={20} /> : 
                                          <XCircle className="text-red-500" size={20} />
                                        }
                                        <div className="flex gap-2 ml-auto">
                                          <button
                                            onClick={() => iniciarEdicaoViagem(v)}
                                            className="text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50"
                                            title="Editar viagem"
                                          >
                                            <Edit size={18} />
                                          </button>
                                          <button
                                            onClick={() => excluirViagem(v.id)}
                                            className="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-50"
                                            title="Excluir viagem"
                                          >
                                            <X size={18} />
                                          </button>
                                        </div>
                                      </div>
                                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-600">
                                        <p className="flex items-center gap-1"><User /> {v.motorista}</p>
                                        <p className="flex items-center gap-1"><Car size={16} /> {v.veiculo}</p>
                                        <p className="flex items-center gap-1"><MapPin /> {v.distancia} km</p>
                                        <p>⛽ {v.litrosAbastecidos}L × R$ {v.precoLitro}/L</p>
                                        <p>📊 Consumo: {calcularConsumo(v)} km/L</p>
                                        <p className="flex items-center gap-1"><Calendar size={14} /> Data Viagem: {v.dataViagem || v.dataRegistro}</p>
                                        <p className="text-xs text-gray-500">📝 Registro: {v.dataRegistro} • {v.horaRegistro}</p>
                                      </div>
                                      {v.despesas && v.despesas.length > 0 && (
                                        <div className="mt-3">
                                          <p className="font-semibold text-sm mb-1">Despesas Adicionais:</p>
                                          <div className="flex flex-wrap gap-2">
                                            {v.despesas.map((d, i) => (
                                              <span key={i} className="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">
                                                {d.categoria}: R$ {d.valor}
                                              </span>
                                            ))}
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                    <div className="text-right">
                                      {v.valorVenda && (
                                        <p className="text-sm font-semibold text-blue-600 mb-1">
                                          💰 Venda: R$ {v.valorVenda}
                                        </p>
                                      )}
                                      <p className="text-sm text-gray-700">
                                        Combustível: R$ {calcularCombustivel(v)}
                                      </p>
                                      <p className="text-md font-semibold text-gray-800 mt-1">
                                        Total Despesas: R$ {calcularTotalDespesas(v)}
                                      </p>
                                      {v.valorVenda && (
                                        <div className={`mt-2 px-3 py-2 rounded-lg ${lucroPositivo ? 'bg-green-100' : 'bg-red-100'}`}>
                                          <p className={`text-sm font-semibold flex items-center gap-1 justify-end ${lucroPositivo ? 'text-green-700' : 'text-red-700'}`}>
                                            {lucroPositivo ? <TrendingUp size={16} /> : <TrendingDown size={16} />}
                                            {lucroPositivo ? 'Lucro' : 'Prejuízo'}: R$ {Math.abs(parseFloat(lucro)).toFixed(2)}
                                          </p>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    )}

                    {/* ABA CADASTROS */}
                    {activeTab === 'cadastros' && (
                      <div className="space-y-6">
                        {USE_GOOGLE_SHEETS && (
                          <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                            <p className="text-sm text-green-800 flex items-center gap-2">
                              <Cloud size={14} />
                              <strong>Sincronizado!</strong> Alterações salvas no Google Sheets
                            </p>
                          </div>
                        )}
                        
                        {[
                          { titulo: 'Categorias de Despesas', items: despesas, tipo: 'despesa', icon: DollarSign },
                          { titulo: 'Motoristas', items: motoristas, tipo: 'motorista', icon: User },
                          { titulo: 'Veículos', items: veiculos, tipo: 'veiculo', icon: Car },
                          { titulo: 'Clientes', items: clientes, tipo: 'cliente', icon: User }
                        ].map((cat) => (
                          <div key={cat.tipo} className="border-b pb-6">
                            <h3 className="text-xl font-bold mb-3 flex items-center gap-2">
                              <cat.icon size={20} />
                              {cat.titulo}
                              <span className="text-sm font-normal text-gray-500">({cat.items.length})</span>
                            </h3>
                            <div className="flex gap-2 mb-3">
                              <input
                                type="text"
                                value={novoItem}
                                onChange={(e) => setNovoItem(e.target.value)}
                                placeholder={`Novo ${cat.titulo.toLowerCase().slice(0, -1)}`}
                                className="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                onKeyPress={(e) => e.key === 'Enter' && adicionarNovoItem(cat.tipo)}
                              />
                              <button
                                onClick={() => adicionarNovoItem(cat.tipo)}
                                className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition disabled:bg-gray-400"
                                disabled={carregando}
                              >
                                <Plus />
                              </button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                              {cat.items.map((item, i) => (
                                <div key={i} className="bg-gray-100 px-3 py-2 rounded-full text-sm flex items-center gap-2">
                                  {editandoItem === item && tipoEditando === cat.tipo ? (
                                    <>
                                      <input
                                        type="text"
                                        value={itemEditado}
                                        onChange={(e) => setItemEditado(e.target.value)}
                                        className="border rounded px-2 py-0.5 text-sm w-32 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        onKeyPress={(e) => e.key === 'Enter' && salvarEdicao()}
                                        autoFocus
                                      />
                                      <button onClick={salvarEdicao} className="text-green-600 font-bold">✓</button>
                                      <button onClick={cancelarEdicao} className="text-gray-600 font-bold">✗</button>
                                    </>
                                  ) : (
                                    <>
                                      <span>{item}</span>
                                      <button 
                                        onClick={() => iniciarEdicao(item, cat.tipo)}
                                        className="text-blue-600 text-xs hover:text-blue-800"
                                        disabled={carregando}
                                        title="Editar"
                                      >
                                        ✏️
                                      </button>
                                      <button 
                                        onClick={() => removerItem(item, cat.tipo)}
                                        className="text-red-600 text-xs hover:text-red-800"
                                        disabled={carregando}
                                        title="Remover"
                                      >
                                        🗑️
                                      </button>
                                    </>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* MODAL NOVA/EDITAR VIAGEM */}
              {showNewTrip && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={() => {setShowNewTrip(false); setEditandoViagem(null);}}>
                  <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="p-6">
                      <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">{editandoViagem ? 'Editar Viagem' : 'Nova Viagem'}</h2>
                        <button onClick={() => {setShowNewTrip(false); setEditandoViagem(null);}} className="text-gray-500 hover:text-gray-700">
                          <X size={24} />
                        </button>
                      </div>

                      <div className="space-y-4">
                        {/* DATA DA VIAGEM */}
                        <div>
                          <label className="block font-semibold mb-2 flex items-center gap-2">
                            <Calendar size={18} />
                            Data da Viagem
                          </label>
                          <input
                            type="date"
                            value={novaViagem.dataViagem}
                            onChange={(e) => setNovaViagem({...novaViagem, dataViagem: e.target.value})}
                            className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          />
                          <p className="text-xs text-gray-500 mt-1">Deixe em branco para usar a data de hoje</p>
                        </div>

                        {/* CLIENTE */}
                        <div>
                          <label className="block font-semibold mb-2">Cliente *</label>
                          {!showAddCliente ? (
                            <div className="flex gap-2">
                              <div className="flex-1 relative">
                                <input
                                  type="text"
                                  value={searchCliente}
                                  onChange={(e) => {
                                    setSearchCliente(e.target.value);
                                    setShowClienteDropdown(true);
                                  }}
                                  onFocus={() => setShowClienteDropdown(true)}
                                  onBlur={() => setTimeout(() => setShowClienteDropdown(false), 200)}
                                  placeholder="Digite para buscar ou criar novo"
                                  className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                                {showClienteDropdown && clientesFiltrados.length > 0 && (
                                  <div className="absolute z-10 w-full bg-white border rounded-b shadow-lg max-h-48 overflow-y-auto">
                                    {clientesFiltrados.map((c, i) => (
                                      <div
                                        key={i}
                                        onClick={() => {
                                          setNovaViagem({...novaViagem, cliente: c});
                                          setSearchCliente(c);
                                          setShowClienteDropdown(false);
                                        }}
                                        className="px-3 py-2 hover:bg-indigo-50 cursor-pointer"
                                      >
                                        {c}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                              <button onClick={() => setShowAddCliente(true)} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                <Plus />
                              </button>
                            </div>
                          ) : (
                            <div className="flex gap-2">
                              <input
                                type="text"
                                value={novoClienteTemp}
                                onChange={(e) => setNovoClienteTemp(e.target.value)}
                                placeholder="Nome do novo cliente"
                                className="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                                onKeyPress={(e) => e.key === 'Enter' && adicionarClienteRapido()}
                                autoFocus
                              />
                              <button onClick={adicionarClienteRapido} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">✓</button>
                              <button onClick={() => {setShowAddCliente(false); setNovoClienteTemp('');}} className="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                                <X />
                              </button>
                            </div>
                          )}
                        </div>

                        {/* MOTORISTA */}
                        <div>
                          <label className="block font-semibold mb-2">Motorista *</label>
                          {!showAddMotorista ? (
                            <div className="flex gap-2">
                              <div className="flex-1 relative">
                                <input
                                  type="text"
                                  value={searchMotorista}
                                  onChange={(e) => {
                                    setSearchMotorista(e.target.value);
                                    setShowMotoristaDropdown(true);
                                  }}
                                  onFocus={() => setShowMotoristaDropdown(true)}
                                  onBlur={() => setTimeout(() => setShowMotoristaDropdown(false), 200)}
                                  placeholder="Digite para buscar ou criar novo"
                                  className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                                {showMotoristaDropdown && motoristasFiltrados.length > 0 && (
                                  <div className="absolute z-10 w-full bg-white border rounded-b shadow-lg max-h-48 overflow-y-auto">
                                    {motoristasFiltrados.map((m, i) => (
                                      <div
                                        key={i}
                                        onClick={() => {
                                          setNovaViagem({...novaViagem, motorista: m});
                                          setSearchMotorista(m);
                                          setShowMotoristaDropdown(false);
                                        }}
                                        className="px-3 py-2 hover:bg-indigo-50 cursor-pointer"
                                      >
                                        {m}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                              <button onClick={() => setShowAddMotorista(true)} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                <Plus />
                              </button>
                            </div>
                          ) : (
                            <div className="flex gap-2">
                              <input
                                type="text"
                                value={novoMotoristaTemp}
                                onChange={(e) => setNovoMotoristaTemp(e.target.value)}
                                placeholder="Nome do motorista"
                                className="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                                onKeyPress={(e) => e.key === 'Enter' && adicionarMotoristaRapido()}
                                autoFocus
                              />
                              <button onClick={adicionarMotoristaRapido} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">✓</button>
                              <button onClick={() => {setShowAddMotorista(false); setNovoMotoristaTemp('');}} className="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                                <X />
                              </button>
                            </div>
                          )}
                        </div>

                        {/* VEÍCULO */}
                        <div>
                          <label className="block font-semibold mb-2">Veículo *</label>
                          {!showAddVeiculo ? (
                            <div className="flex gap-2">
                              <div className="flex-1 relative">
                                <input
                                  type="text"
                                  value={searchVeiculo}
                                  onChange={(e) => {
                                    setSearchVeiculo(e.target.value);
                                    setShowVeiculoDropdown(true);
                                  }}
                                  onFocus={() => setShowVeiculoDropdown(true)}
                                  onBlur={() => setTimeout(() => setShowVeiculoDropdown(false), 200)}
                                  placeholder="Digite para buscar ou criar novo"
                                  className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                                {showVeiculoDropdown && veiculosFiltrados.length > 0 && (
                                  <div className="absolute z-10 w-full bg-white border rounded-b shadow-lg max-h-48 overflow-y-auto">
                                    {veiculosFiltrados.map((v, i) => (
                                      <div
                                        key={i}
                                        onClick={() => {
                                          setNovaViagem({...novaViagem, veiculo: v});
                                          setSearchVeiculo(v);
                                          setShowVeiculoDropdown(false);
                                        }}
                                        className="px-3 py-2 hover:bg-indigo-50 cursor-pointer"
                                      >
                                        {v}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                              <button onClick={() => setShowAddVeiculo(true)} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                <Plus />
                              </button>
                            </div>
                          ) : (
                            <div className="flex gap-2">
                              <input
                                type="text"
                                value={novoVeiculoTemp}
                                onChange={(e) => setNovoVeiculoTemp(e.target.value)}
                                placeholder="Ex: Fiat Uno - ABC-1234"
                                className="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                                onKeyPress={(e) => e.key === 'Enter' && adicionarVeiculoRapido()}
                                autoFocus
                              />
                              <button onClick={adicionarVeiculoRapido} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">✓</button>
                              <button onClick={() => {setShowAddVeiculo(false); setNovoVeiculoTemp('');}} className="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                                <X />
                              </button>
                            </div>
                          )}
                        </div>

                        {/* VALOR DA VENDA */}
                        <div>
                          <label className="block font-semibold mb-2 flex items-center gap-2">
                            <DollarSign size={18} />
                            Valor da Venda (Receita)
                          </label>
                          <input
                            type="number"
                            step="0.01"
                            value={novaViagem.valorVenda}
                            onChange={(e) => setNovaViagem({...novaViagem, valorVenda: e.target.value})}
                            placeholder="Ex: 500.00"
                            className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          />
                        </div>

                        {/* DADOS DO COMBUSTÍVEL */}
                        <div className="grid grid-cols-3 gap-3">
                          <div>
                            <label className="block font-semibold mb-2 text-sm">Preço/Litro (R$)</label>
                            <input
                              type="number"
                              step="0.01"
                              value={novaViagem.precoLitro}
                              onChange={(e) => setNovaViagem({...novaViagem, precoLitro: e.target.value})}
                              placeholder="5.50"
                              className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                          <div>
                            <label className="block font-semibold mb-2 text-sm">Litros</label>
                            <input
                              type="number"
                              step="0.01"
                              value={novaViagem.litrosAbastecidos}
                              onChange={(e) => setNovaViagem({...novaViagem, litrosAbastecidos: e.target.value})}
                              placeholder="30"
                              className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                          <div>
                            <label className="block font-semibold mb-2 text-sm">Distância (km)</label>
                            <input
                              type="number"
                              value={novaViagem.distancia}
                              onChange={(e) => setNovaViagem({...novaViagem, distancia: e.target.value})}
                              placeholder="150"
                              className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                          </div>
                        </div>

                        {/* RESUMO FINANCEIRO */}
                        {(novaViagem.precoLitro && novaViagem.litrosAbastecidos) || novaViagem.valorVenda ? (
                          <div className="bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-lg border border-indigo-200">
                            <p className="font-semibold mb-3 text-indigo-900">Resumo Financeiro</p>
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <p className="text-xs text-gray-600 mb-1">Combustível</p>
                                <p className="font-bold text-lg text-red-600">R$ {calcularCombustivel()}</p>
                              </div>
                              {novaViagem.distancia && parseFloat(novaViagem.distancia) > 0 && (
                                <div>
                                  <p className="text-xs text-gray-600 mb-1">Consumo Médio</p>
                                  <p className="font-semibold text-lg">{calcularConsumo()} km/L</p>
                                </div>
                              )}
                              <div>
                                <p className="text-xs text-gray-600 mb-1">Total Despesas</p>
                                <p className="font-bold text-lg text-red-600">R$ {calcularTotalDespesas(novaViagem)}</p>
                              </div>
                              {novaViagem.valorVenda && (
                                <div className={`p-2 rounded ${parseFloat(calcularLucro(novaViagem)) >= 0 ? 'bg-green-100' : 'bg-red-100'}`}>
                                  <p className="text-xs text-gray-600 mb-1">Lucro/Prejuízo</p>
                                  <p className={`font-bold text-lg ${parseFloat(calcularLucro(novaViagem)) >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                                    R$ {calcularLucro(novaViagem)}
                                  </p>
                                </div>
                              )}
                            </div>
                          </div>
                        ) : null}

                        {/* STATUS DA VIAGEM */}
                        <div>
                          <label className="block font-semibold mb-2">Status da Viagem</label>
                          <div className="flex gap-3">
                            <button
                              onClick={() => setNovaViagem({...novaViagem, bemSucedida: true})}
                              className={`flex-1 py-2 rounded border-2 transition text-sm font-semibold ${
                                novaViagem.bemSucedida ? 'border-green-500 bg-green-50 text-green-700' : 'border-gray-300 text-gray-600'
                              }`}
                            >
                              <CheckCircle className="inline mr-1" size={16} />
                              Bem-Sucedida
                            </button>
                            <button
                              onClick={() => setNovaViagem({...novaViagem, bemSucedida: false})}
                              className={`flex-1 py-2 rounded border-2 transition text-sm font-semibold ${
                                !novaViagem.bemSucedida ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-300 text-gray-600'
                              }`}
                            >
                              <XCircle className="inline mr-1" size={16} />
                              Problema
                            </button>
                          </div>
                        </div>

                        {/* DESPESAS ADICIONAIS */}
                        <div>
                          <div className="flex justify-between items-center mb-2">
                            <label className="font-semibold text-sm">Despesas Adicionais</label>
                            <button
                              onClick={() => setShowAddDespesa(true)}
                              className="text-indigo-600 text-sm flex items-center gap-1 hover:text-indigo-800"
                            >
                              <Plus size={14} />
                              Adicionar Despesa
                            </button>
                          </div>
                          
                          {showAddDespesa && (
                            <div className="border rounded p-3 mb-2 bg-gray-50">
                              <div className="grid grid-cols-2 gap-2 mb-2">
                                {!showAddCategoria ? (
                                  <div className="flex gap-1 relative">
                                    <div className="flex-1 relative">
                                      <input
                                        type="text"
                                        value={searchCategoria}
                                        onChange={(e) => {
                                          setSearchCategoria(e.target.value);
                                          setShowCategoriaDropdown(true);
                                        }}
                                        onFocus={() => setShowCategoriaDropdown(true)}
                                        onBlur={() => setTimeout(() => setShowCategoriaDropdown(false), 200)}
                                        placeholder="Categoria"
                                        className="w-full border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                      />
                                      {showCategoriaDropdown && despesasFiltradas.length > 0 && (
                                        <div className="absolute z-10 w-full bg-white border rounded-b shadow-lg max-h-32 overflow-y-auto">
                                          {despesasFiltradas.map((d, i) => (
                                            <div
                                              key={i}
                                              onClick={() => {
                                                setNovaDespesa({...novaDespesa, categoria: d});
                                                setSearchCategoria(d);
                                                setShowCategoriaDropdown(false);
                                              }}
                                              className="px-2 py-1 hover:bg-indigo-50 cursor-pointer text-sm"
                                            >
                                              {d}
                                            </div>
                                          ))}
                                        </div>
                                      )}
                                    </div>
                                    <button
                                      onClick={() => setShowAddCategoria(true)}
                                      className="bg-green-600 text-white px-2 rounded hover:bg-green-700"
                                    >
                                      <Plus size={14} />
                                    </button>
                                  </div>
                                ) : (
                                  <div className="flex gap-1">
                                    <input
                                      type="text"
                                      value={novaCategoriaTemp}
                                      onChange={(e) => setNovaCategoriaTemp(e.target.value)}
                                      placeholder="Nova categoria"
                                      className="flex-1 border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-green-500"
                                      onKeyPress={(e) => e.key === 'Enter' && adicionarCategoriaRapida()}
                                      autoFocus
                                    />
                                    <button onClick={adicionarCategoriaRapida} className="bg-green-600 text-white px-2 rounded text-sm hover:bg-green-700">✓</button>
                                    <button onClick={() => {setShowAddCategoria(false); setNovaCategoriaTemp('');}} className="bg-gray-300 px-2 rounded text-sm hover:bg-gray-400">
                                      <X size={14} />
                                    </button>
                                  </div>
                                )}
                                <input
                                  type="number"
                                  step="0.01"
                                  value={novaDespesa.valor}
                                  onChange={(e) => setNovaDespesa({...novaDespesa, valor: e.target.value})}
                                  placeholder="Valor (R$)"
                                  className="border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                />
                              </div>
                              <div className="flex gap-2">
                                <button
                                  onClick={adicionarDespesa}
                                  className="flex-1 bg-indigo-600 text-white py-1 rounded text-sm hover:bg-indigo-700"
                                >
                                  Confirmar
                                </button>
                                <button
                                  onClick={() => {
                                    setShowAddDespesa(false); 
                                    setNovaDespesa({ categoria: '', valor: '' }); 
                                    setSearchCategoria('');
                                  }}
                                  className="flex-1 bg-gray-300 py-1 rounded text-sm hover:bg-gray-400"
                                >
                                  Cancelar
                                </button>
                              </div>
                            </div>
                          )}
                          
                          <div className="space-y-2">
                            {novaViagem.despesas.map((d) => (
                              <div key={d.id} className="flex justify-between items-center bg-gray-50 p-2 rounded">
                                <span className="text-sm font-semibold">{d.categoria}: <span className="text-red-600">R$ {d.valor}</span></span>
                                <button onClick={() => removerDespesa(d.id)} className="text-red-500 hover:text-red-700">
                                  <X size={16} />
                                </button>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* BOTÃO SALVAR */}
                        <button
                          onClick={salvarViagem}
                          disabled={carregando}
                          className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition font-semibold flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        >
                          <Save />
                          {carregando ? 'Salvando...' : editandoViagem ? 'Atualizar Viagem' : USE_GOOGLE_SHEETS ? 'Salvar no Google Sheets' : 'Salvar Viagem'}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TravelControl />);
    </script>
</body>
</html>
